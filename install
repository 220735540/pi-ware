#!/bin/bash

#Variables
PW_PREFIX="$HOME/.local"
fwe="0"
ers=""

#Functions
function error {
  echo -e "\e[91m$1\e[39m"
  if [ "$2" == "exit" ]; then
    exit 1
  else
    fwe="1"
    ers+="$1"
  fi
}

function warning {
  echo -e "\e[91m$2\e[39m"
  sleep "$1"
}

#Main
echo "Installing pi-ware..."
#Make required directory for updater
mkdir -p "$PW_PREFIX/share/pi-ware"
mkdir -p "$PW_PREFIX/bin"
echo $(git rev-parse main) > "$PW_PREFIX/share/pi-ware/version"
#Install pi-ware
echo "Installing pi-ware..."
echo "Creating a desktop entry for Pi-Ware..."
sudo mkdir -p $HOME/.local/share/applications
echo "[Desktop Entry]
Name=Pi-Ware
Comment=Raspberry Pi app store
Exec=python3 $HOME/pi-ware/store.py
Icon=$HOME/pi-ware/icons/logo.png
Categories=Utility;
Type=Application
Terminal=false" > $HOME/.local/share/applications/pi-ware.desktop
echo "Creating a settings desktop entry for Pi-Ware..."
sudo mkdir -p $HOME/.local/share/applications
echo "[Desktop Entry]
Name=Pi-Ware Settings
Comment=Change some of pi-ware's settings
Exec=python3 $HOME/pi-ware/func/settings.py
Icon=$HOME/pi-ware/icons/logo.png
Categories=Utility;
Type=Application
Terminal=false" > $HOME/.local/share/applications/pi-ware-settings.desktop
echo "Creating an auto updater for Pi-Ware..."
mkdir -p $HOME/.config/autostart/
echo "[Desktop Entry]
Name=Pi-Ware-Auto-Updater
Comment=Auto updater for pi-ware
Exec=bash $HOME/pi-ware/func/auto-update
Icon=$HOME/pi-ware/icons/logo.png
Categories=Utility;
Type=Application
Terminal=false" > $HOME/.config/autostart/update-pi-ware.desktop
#Create pi-ware utility
cd $HOME
if [ -d "$HOME/.local" ]; then
 mkdir -p "$HOME/.local/bin"
fi
cd $HOME/pi-ware/func
sudo chmod +x pi-ware-term
cp -r "pi-ware-term" "$HOME/.local/bin/pi-ware"
echo "Added pi-ware-commands to Terminal!"
echo "Please restart terminal to apply changes."
#Set package manager
if [ -f /usr/bin/apt ];then
  echo "Package manager is: apt"
  echo "apt-get" > "$PW_PREFIX/share/pi-ware/inst-pref"
elif [ -f /usr/bin/pacman ];then
  echo "Package manager is: pacman"
  echo "pacman -S" > "$PW_PREFIX/share/pi-ware/inst-pref"
else
  error "Failed to find any package manager."
fi
#install lxterminal if it is not already installed
PACMANG="$(cat $PW_PREFIX/share/pi-ware/inst-pref)"
if ! command -v lxterminal >/dev/null;then
  echo "Installing LXTerminal..."
  sudo $PACKMANG lxterminal
fi

#Inform user that the install has finished
#Check if finished with errors
if [ "${fwe}" == "1" ]; then
  echo "The install finished with errors, Here are the errors: ${ers}"
  exit 1
elif [ "${fwe}" == "0" ]; then
  echo "Done!"
  echo "You can find Pi-Ware in Menu > Accessories > Pi-Ware."
  exit 0
fi
