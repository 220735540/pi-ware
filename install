#!/bin/bash

#Variables
export PW_ACTION="$1"

#Functions
install()
{
  if [ "$PW_ACTION" != "update" ]; then
    if [ "$PW_ACTION" == "apt" ]; then
      $2
    elif [ "$PW_ACTION" == "echo" ]; then
      echo -e "$2"
    fi
  fi
}

# If executed directly from outside the repo
if [[ ! -d ".git" ]]; then
	git clone https://github.com/zachthecoder14/pi-ware.git
	cd pi-ware
fi

install echo "Installing dependencies..."
install apt "sudo apt install -qq -y git python3 python3-tk"

install echo "Installing Pi-Ware..."
mkdir -p "$HOME/.local/share/applications"
mkdir -p "$HOME/.local/share/pi-ware"
mkdir -p "$HOME/.local/share/icons"
mkdir -p "$HOME/.local/bin"
rsync -r ./apps/ "$HOME/.local/share/pi-ware" --delete
rsync ./{uninstall,install,update} "$HOME/.local/share/pi-ware/scripts"
rsync ./term "$HOME/.local/bin/pi-ware"
rsync ./dist_icon.png "$HOME/.local/share/icons/pi-ware.png"
chmod a+x "$HOME/.local/bin/pi-ware"
echo $(git rev-parse main) > "$HOME/.local/share/pi-ware/version"

install echo "Creating a desktop entry for Pi-Ware..."
install echo "[Desktop Entry]
Name=Pi-Ware
Comment=Raspberry Pi app store
Exec=sudo python3 $HOME/.local/bin/pi-ware
Icon=$HOME/.local/share/icons/pi-ware.png
Categories=Utility;
Type=Application
Terminal=false" > "$HOME/.local/share/applications/pi-ware.desktop"
install echo "Done! You can find Pi-Ware in Menu > Accessories > Pi-Ware."
install echo "Note: you may need to restart your shell/terminal to be able to run Pi-Ware."
